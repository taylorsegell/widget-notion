"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(e,t){var o=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=o){var r,i,n,a,s=[],l=!0,c=!1;try{if(n=(o=o.call(e)).next,0===t){if(Object(o)!==o)return;l=!1}else for(;!(l=(r=n.call(o)).done)&&(s.push(r.value),s.length!==t);l=!0);}catch(e){c=!0,i=e}finally{try{if(!l&&null!=o.return&&(a=o.return(),Object(a)!==a))return}finally{if(c)throw i}}return s}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var o=Object.prototype.toString.call(e).slice(8,-1);return"Object"===o&&e.constructor&&(o=e.constructor.name),"Map"===o||"Set"===o?Array.from(e):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var o=0,r=new Array(t);o<t;o++)r[o]=e[o];return r}function ownKeys(t,e){var o=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),o.push.apply(o,r)}return o}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var o=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(o),!0).forEach(function(e){_defineProperty(t,e,o[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(o)):ownKeys(Object(o)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(o,e))})}return t}function _defineProperty(e,t,o){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o=0;o<t.length;o++){var r=t[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,_toPropertyKey(r.key),r)}}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"===_typeof(t)?t:String(t)}function _toPrimitive(e,t){if("object"!==_typeof(e)||null===e)return e;var o=e[Symbol.toPrimitive];if(void 0===o)return("string"===t?String:Number)(e);var r=o.call(e,t||"default");if("object"!==_typeof(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}!function(){var n="start",o="0%",a="25%",s="50%",l="75%",c="100%",u="complete",r="stopped",i=function(){function t(e){_classCallCheck(this,t),this.coreServiceAdapter=e,this.registry=new Map}return _createClass(t,[{key:"getRegistryItem",value:function(e){return this.registry.get(e)||this.resetItemState(e)}},{key:"resetItemState",value:function(e){var t={playedMs:0,beaconQueue:[],lastSegmentStart:Date.now(),lastSegmentStopped:0,isInitialBeacon:!0,isShortVideo:this.getIsShortVideo(e),isComplete:!1,elapsedTimeIntervalRef:void 0,beaconProps:{video_name:this.getTitle(e),video_id:e.dataset.autoSel,video_inview:!0,video_user_initiated_play:this.getUserInitiatedPlay(e),video_seconds_played:0,video_milestone:"start",video_length:Math.floor(e.duration),event:e.autoplay?"content:viewed":"content:engaged",event_class:e.autoplay?"auto":"user_action",action:e.autoplay?"viewed":"engaged",ui_access_point:this.getUiAccessPoint(e),ui_action:e.autoplay?"viewed":"clicked",ui_object_detail:"viewed ".concat(o," video")}};return this.registry.set(e,t),t}},{key:"updatePlaybackTime",value:function(e){var t=this.getRegistryItem(e),o=(t.lastSegmentStopped||Date.now())-t.lastSegmentStart;t.playedMs+=o,t.beaconProps.video_seconds_played=this.getSecondsPlayed(t),t.lastSegmentStart=Date.now()}},{key:"updateMilestone",value:function(e){var t=e.currentTime,o=e.duration,r=this.getRegistryItem(e),i=!1;t!==o||r.isComplete?3*o/4<=t?(i=r.beaconProps.video_milestone===s&&!r.isShortVideo,r.beaconProps.video_milestone=l,r.beaconProps.ui_object_detail="viewed ".concat(l," video")):o/2<=t?(i=r.beaconProps.video_milestone===a&&!r.isShortVideo,r.beaconProps.video_milestone=s,r.beaconProps.ui_object_detail="viewed ".concat(s," video")):o/4<=t&&(i=r.beaconProps.video_milestone===n&&!r.isShortVideo,r.beaconProps.video_milestone=a,r.beaconProps.ui_object_detail="viewed ".concat(a," video")):(i=r.beaconProps.video_milestone===l,this.setVideoComplete(e),r.beaconProps.video_milestone=u,r.beaconProps.ui_object_detail="viewed ".concat(c," video")),i&&(this.updatePlaybackTime(e),r.playedMs=0,this.setAutoAction(e,!0),this.beacon(e))}},{key:"beacon",value:function(e){var t=this.getRegistryItem(e),o=_objectSpread(_objectSpread({},t.beaconProps),{},{object:"content",object_detail:"video",ui_object:"video_player",video_sound:this.getIsMuted(e)?"sound_off":"sound_on"});for(t.beaconQueue.push(o);t.beaconQueue.length;){var r=t.beaconQueue.shift();this.coreServiceAdapter.analytics.trackEvent(r)}}},{key:"getTitle",value:function(e){var t,o,r;return(null===(t=e.firstElementChild)||void 0===t?void 0:null===(o=t.dataset)||void 0===o?void 0:o.title)||e.dataset.title||"".concat(null===(r=e.closest("[data-com-id]").dataset)||void 0===r?void 0:r.comId,"|video")}},{key:"getSecondsPlayed",value:function(e){var t=e.playedMs;return Math.floor(t/1e3)}},{key:"getIsMuted",value:function(e){return e.muted||0===e.volume}},{key:"getIsModal",value:function(e){var t=this.getUiAccessPoint(e);return t&&t.includes("page-media-modal")}},{key:"getUserInitiatedPlay",value:function(e){return this.getIsModal(e)?"user_play":e.autoplay?"auto_play":"user_play"}},{key:"getIsShortVideo",value:function(e){return e.duration<=15}},{key:"onPlay",value:function(e){var t=this.getRegistryItem(e);t.isComplete||(this.startVideoObserve(e),this.updatePlaybackTime(e),t.lastSegmentStopped=0,this.startTimer(e),t.isInitialBeacon&&(this.beacon(e),t.isInitialBeacon=!1))}},{key:"startTimer",value:function(e){var t=this,o=this.getRegistryItem(e);this.clearElapsedTimeInterval(e),o.elapsedTimeIntervalRef=setInterval(function(){t.updateMilestone(e)},1e3)}},{key:"stopTimer",value:function(e){this.clearElapsedTimeInterval(e),this.storeElapsedTimeOnPause(e)}},{key:"storeElapsedTimeOnPause",value:function(e){var t=this.getRegistryItem(e);t.lastSegmentStopped||(t.lastSegmentStopped=Date.now())}},{key:"clearElapsedTimeInterval",value:function(e){var t=this.getRegistryItem(e);void 0!==t.elapsedTimeIntervalRef&&(clearInterval(t.elapsedTimeIntervalRef),t.elapsedTimeIntervalRef=void 0)}},{key:"onPause",value:function(e){this.updateMilestone(e),this.stopTimer(e)}},{key:"getUiAccessPoint",value:function(e){return function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"|";return e&&e.dataset&&e.dataset.templateId?"".concat((e.dataset.templateId||"").trim()).concat(t).concat((e.dataset.comVersion||"").trim()).concat(t).concat((e.dataset.autoSel||"").trim()).concat(t).concat((e.dataset.instanceVersion||"").trim()):e&&e.dataset&&e.dataset.comId?e.dataset.comId.trim():null}(e.parentElement.closest("[data-com-id]"))}},{key:"setAutoAction",value:function(e,t){var o=this.getRegistryItem(e);o.beaconProps.event=t?"content:viewed":"content:engaged",o.beaconProps.event_class=t?"auto":"user_action",o.beaconProps.action=t?"viewed":"engaged",o.beaconProps.ui_action=t?"viewed":"clicked"}},{key:"onVideoClose",value:function(){var o=this;this.registry.forEach(function(e,t){o.exitVideo(t,e)}),this.registry.clear()}},{key:"exitVideo",value:function(e,t){if(!t&&!e){if(!(e=this.getModalVideoEl()))return;t=this.getRegistryItem(e)}this.stopTimer(e),t.isComplete||(t.beaconProps.ui_object_detail="clicked close",t.beaconProps.video_milestone=r,this.setAutoAction(e,!1),this.updatePlaybackTime(e),this.beacon(e)),this.getIsModal(e)&&this.registry.delete(e)}},{key:"getModalVideoEl",value:function(){var t=this;return _toConsumableArray(this.registry.keys()).find(function(e){return t.getIsModal(e)})}},{key:"registerIntersectionObserver",value:function(){var t=this;this.io=new IntersectionObserver(function(e){t.getRegistryItem(e[0].target).beaconProps.video_inview=e[0].isIntersecting},{threshold:[.5]})}},{key:"startVideoObserve",value:function(e){this.io.observe(e)}},{key:"stopVideoObserve",value:function(e){this.io.unobserve(e)}},{key:"setVideoComplete",value:function(e){this.getRegistryItem(e).isComplete=!0,this.stopVideoObserve(e)}}]),t}();!function(e){var a=new i(e.coreServiceAdapter),t={play:a.onPlay.bind(a),pause:a.onPause.bind(a)},s=["media-video","media-video-set"],l=!0;Object.entries(t).forEach(function(e){var t=_slicedToArray(e,2),o=t[0],n=t[1];document.addEventListener(o,function(e){var t=e.target;if("VIDEO"===t.nodeName){var o;l&&(addEventListener("beforeunload",c,!0),addEventListener("modalHide",u,!0),a.registerIntersectionObserver(),l=!1);var r=t.closest("[data-template-id]"),i=null==r?void 0:null===(o=r.dataset)||void 0===o?void 0:o.templateId;s.includes(i)&&n(t)}},!0)});var c=function(e){a.onVideoClose(),delete e.returnValue},u=function(){a.exitVideo()}}(window)}();